import streamlit as st
import time
from google import genai
from textwrap import dedent

# 1. –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø –ö–õ–Ü–Ñ–ù–¢–ê GEMINI
# –ö–ª—ñ—î–Ω—Ç —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î—Ç—å—Å—è –û–î–ò–ù —Ä–∞–∑ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é st.secrets.
client = None
if "GEMINI_API_KEY" in st.secrets:
    try:
        # st.secrets –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —á–∏—Ç–∞—î –∫–ª—é—á —ñ–∑ secrets.toml
        client = genai.Client(api_key=st.secrets["GEMINI_API_KEY"])
    except Exception:
        # –Ø–∫—â–æ –∫–ª—é—á –Ω–µ–¥—ñ–π—Å–Ω–∏–π
        client = None

def generate_shpora(input_text):
    if not input_text.strip():
        return "–í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É."

    # –°—Ç–≤–æ—Ä—é—î–º–æ –ø—Ä–æ–º–ø—Ç
    prompt = dedent(f"""
    –ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π –Ω–∞—Å—Ç—É–ø–Ω–∏–π —Ç–µ–∫—Å—Ç —ñ –≤–∏–∫–æ–Ω–∞–π —Ç—Ä–∏ –æ–∫—Ä–µ–º—ñ –∑–∞–≤–¥–∞–Ω–Ω—è:

    1. –ö–õ–Æ–ß–û–í–Ü –í–ò–°–ù–û–í–ö–ò: –°—Ç–∏—Å–Ω–∏ –≤–µ—Å—å —Ç–µ–∫—Å—Ç –¥–æ 5-7 –Ω–∞–π–±—ñ–ª—å—à –≤–∞–∂–ª–∏–≤–∏—Ö, –Ω–µ–∑–∞–ª–µ–∂–Ω–∏—Ö —Ä–µ—á–µ–Ω—å. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ "## 1. –ö–ª—é—á–æ–≤—ñ –í–∏—Å–Ω–æ–≤–∫–∏ —Ç–∞ –†–µ–∑—é–º–µ".

    2. –û–°–ù–û–í–ù–Ü –¢–ï–†–ú–Ü–ù–ò: –í–∏–¥—ñ–ª–∏ 5-10 –Ω–∞–π–±—ñ–ª—å—à –≤–∞–∂–ª–∏–≤–∏—Ö —Ç–µ—Ä–º—ñ–Ω—ñ–≤ –∞–±–æ –∫–æ–Ω—Ü–µ–ø—Ü—ñ–π —ñ–∑ —Ç–µ–∫—Å—Ç—É —ñ –¥–∞–π —Å—Ç–∏—Å–ª–µ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ (–Ω–µ –±—ñ–ª—å—à–µ –æ–¥–Ω–æ–≥–æ —Ä–µ—á–µ–Ω–Ω—è –Ω–∞ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è). –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ "## 2. –ì–ª–æ—Å–∞—Ä—ñ–π –û—Å–Ω–æ–≤–Ω–∏—Ö –¢–µ—Ä–º—ñ–Ω—ñ–≤". –§–æ—Ä–º–∞—Ç: "**–¢–µ—Ä–º—ñ–Ω:** –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è.".

    3. –ü–ò–¢–ê–ù–ù–Ø –î–õ–Ø –°–ê–ú–û–ü–ï–†–ï–í–Ü–†–ö–ò: –°—Ñ–æ—Ä–º—É–ª—é–π 5-7 –ø–∏—Ç–∞–Ω—å, —è–∫—ñ –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∑–Ω–∞–Ω—å –∑–∞ —Ü–∏–º —Ç–µ–∫—Å—Ç–æ–º. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ "## 3. –ü–∏—Ç–∞–Ω–Ω—è –¥–ª—è –°–∞–º–æ–ø–µ—Ä–µ–≤—ñ—Ä–∫–∏".

    –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –ª–∏—à–µ —É–∫—Ä–∞—ó–Ω—Å—å–∫—É –º–æ–≤—É.

    –û–°–ù–û–í–ù–ò–ô –¢–ï–ö–°–¢ –î–õ–Ø –ê–ù–ê–õ–Ü–ó–£:
    ---
    {input_text}
    ---
    """)
    
    # 2. –í–ò–ö–õ–ò–ö API
    try:
        response = client.models.generate_content(
            model='gemini-2.5-flash',
            contents=prompt
        )
        return response.text
    except Exception as e:
        return f"[[LLM_REQUEST_FAILED]]–ü–æ–º–∏–ª–∫–∞ –≤–∏–∫–ª–∏–∫—É LLM. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–ª—é—á API —Ç–∞ –ª—ñ–º—ñ—Ç–∏: {e}"


def main():
    st.set_page_config(layout="wide")
    st.title('üìù –ö–æ–Ω—Å–ø–µ–∫—Ç-–ö–æ–º–ø—Ä–µ—Å–æ—Ä: –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –û—Å–≤—ñ—Ç–Ω—ñ—Ö –®–ø–∞—Ä–≥–∞–ª–æ–∫')
    st.subheader('–ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î –¥–æ–≤–≥–∏–π —Ç–µ–∫—Å—Ç –Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–∏–π –Ω–∞–≤—á–∞–ª—å–Ω–∏–π –º–∞—Ç–µ—Ä—ñ–∞–ª (LLM-Driven)')

    # –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è, —è–∫—â–æ –∫–ª—é—á –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ
    if client is None:
        st.error("‚ùå –ê–í–¢–û–ù–û–ú–ù–ò–ô –†–ï–ñ–ò–ú –ù–ï –ü–†–ê–¶–Æ–Ñ.")
        st.warning("–ë—É–¥—å –ª–∞—Å–∫–∞, –ø–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ —Ñ–∞–π–ª .streamlit/secrets.toml —ñ—Å–Ω—É—î —ñ –º—ñ—Å—Ç–∏—Ç—å –¥—ñ–π—Å–Ω–∏–π GEMINI_API_KEY.")
        # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å—Ç–∞—Ä–∏–π —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª –¥–ª—è –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è, —è–∫—â–æ –∞–≤—Ç–æ–Ω–æ–º–Ω–∏–π —Ä–µ–∂–∏–º –Ω–µ –ø—Ä–∞—Ü—é—î
        st.markdown(dedent("""
            ---
            **–†–µ–∂–∏–º –¥–ª—è –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è:** –î–æ–¥–∞—Ç–æ–∫ –ø—Ä–∞—Ü—é—î, –∞–ª–µ –≤–∏–º–∞–≥–∞—î —Ä—É—á–Ω–æ–≥–æ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—É –º–µ–Ω—ñ –≤ —á–∞—Ç.
        """))
        # –£ —Ä–∞–∑—ñ –Ω–µ–≤–¥–∞—á—ñ, –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—é, —è–∫–∞ –ø—Ä–æ—Å—Ç–æ —Ñ–æ—Ä–º—É—î –ø—Ä–æ–º–ø—Ç –¥–ª—è –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è
        def generate_shpora_manual(input_text):
            if not input_text.strip():
                return "–í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É."
            # ... –ª–æ–≥—ñ–∫–∞ —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è ... (—è–∫ —É –≤–∞—à—ñ–π —Å—Ç–∞—Ä—ñ–π –≤–µ—Ä—Å—ñ—ó)
            prompt = dedent(f"""
            –ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π –Ω–∞—Å—Ç—É–ø–Ω–∏–π —Ç–µ–∫—Å—Ç —ñ –≤–∏–∫–æ–Ω–∞–π —Ç—Ä–∏ –æ–∫—Ä–µ–º—ñ –∑–∞–≤–¥–∞–Ω–Ω—è:
            ... (–ø–æ–≤–Ω–∏–π –ø—Ä–æ–º–ø—Ç) ...
            –û–°–ù–û–í–ù–ò–ô –¢–ï–ö–°–¢ –î–õ–Ø –ê–ù–ê–õ–Ü–ó–£:
            ---
            {input_text}
            ---
            """)
            return f"[[LLM_REQUEST_START]]{prompt}"
        
        # –í–∏–∑–Ω–∞—á–∞—î–º–æ, —è–∫—É —Ñ—É–Ω–∫—Ü—ñ—é –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏
        shpora_generator_function = generate_shpora_manual
        button_text = '‚ö†Ô∏è –°—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ –ó–∞–ø–∏—Ç –¥–ª—è –ß–∞—Ç—É'
        success_message = "‚úÖ –ó–∞–ø–∏—Ç —É—Å–ø—ñ—à–Ω–æ —Å—Ñ–æ—Ä–º–æ–≤–∞–Ω–æ. –ü–µ—Ä–µ–¥–∞—é —è–¥—Ä—É LLM (–º–µ–Ω—ñ)..."
    else:
        # –£—Å–ø—ñ—à–Ω–æ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ, –ø—Ä–∞—Ü—é—î–º–æ –≤ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–º—É —Ä–µ–∂–∏–º—ñ
        st.success("‚úÖ –ê–í–¢–û–ù–û–ú–ù–ò–ô –†–ï–ñ–ò–ú –ê–ö–¢–ò–í–û–í–ê–ù–û. –î–æ–¥–∞—Ç–æ–∫ –≥–µ–Ω–µ—Ä—É—î —à–ø–∞—Ä–≥–∞–ª–∫—É —Å–∞–º–æ—Å—Ç—ñ–π–Ω–æ.")
        shpora_generator_function = generate_shpora
        button_text = 'üöÄ –°—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ –®–ø–∞—Ä–≥–∞–ª–∫—É –ê–í–¢–û–ù–û–ú–ù–û'
        success_message = "‚úÖ –ó–∞–ø–∏—Ç —É—Å–ø—ñ—à–Ω–æ —Å—Ñ–æ—Ä–º–æ–≤–∞–Ω–æ. –û—á—ñ–∫—É–π—Ç–µ –Ω–∞ —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç..."

    # ... –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è
    st.markdown(dedent("""
        **–Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è:** –í—Å—Ç–∞–≤—Ç–µ –≤–µ–ª–∏–∫–∏–π —à–º–∞—Ç–æ–∫ —Ç–µ–∫—Å—Ç—É (–ø–∞—Ä–∞–≥—Ä–∞—Ñ, –≤–∏—Ç—è–≥ —ñ–∑ –∑–∞–∫–æ–Ω—É, –Ω–∞—É–∫–æ–≤—É —Å—Ç–∞—Ç—Ç—é) —É –ø–æ–ª–µ –Ω–∏–∂—á–µ.
        –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É, —ñ LLM-—è–¥—Ä–æ –∑–≥–µ–Ω–µ—Ä—É—î –¥–ª—è –≤–∞—Å —à–ø–∞—Ä–≥–∞–ª–∫—É.
    """))

    input_text = st.text_area(
        "–í—Å—Ç–∞–≤—Ç–µ —Ç–µ–∫—Å—Ç —Ç—É—Ç:",
        height=300,
        placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: '–ó–∞–∫–æ–Ω –ø—Ä–æ –¥–µ—Ä–∂–∞–≤–Ω—É –ø—ñ–¥—Ç—Ä–∏–º–∫—É ...' –∞–±–æ '–¢–µ–æ—Ä—ñ—è –≤—ñ–¥–Ω–æ—Å–Ω–æ—Å—Ç—ñ –ï–π–Ω—à—Ç–µ–π–Ω–∞...' "
    )

    if st.button(button_text):
        if not input_text.strip():
            st.warning("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤—Å—Ç–∞–≤—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É.")
            return

        with st.spinner('–ê–Ω–∞–ª—ñ–∑ —Ç–µ–∫—Å—Ç—É —Ç–∞ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≤—ñ–¥ LLM...'):
            result = shpora_generator_function(input_text)
            
            st.success(success_message)
            st.markdown("---")

            if result.startswith("[[LLM_REQUEST_START]]"):
                 # –õ–æ–≥—ñ–∫–∞ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è (—è–∫—â–æ –∞–≤—Ç–æ–Ω–æ–º–Ω–∏–π —Ä–µ–∂–∏–º –Ω–µ —Å–ø—Ä–∞—Ü—é–≤–∞–≤)
                st.markdown("### –ó–∞–ø–∏—Ç –¥–æ LLM (–í–∏–∫–æ–Ω–∞–π—Ç–µ —Ü—é –∂–æ—Ä—Å—Ç–∫—É –∫–æ–º–∞–Ω–¥—É –≤ —á–∞—Ç—ñ):")
                final_prompt = result.replace("[[LLM_REQUEST_START]]", "")
                st.code(final_prompt, language="markdown")
                st.warning("–ö–û–õ–ò –í–ò –ë–ê–ß–ò–¢–ï –¶–ï–ô –ï–ö–†–ê–ù: **–°–∫–æ–ø—ñ—é–π—Ç–µ –≤–º—ñ—Å—Ç –±–ª–æ–∫—É '–ó–∞–ø–∏—Ç –¥–æ LLM' —ñ –≤—Å—Ç–∞–≤—Ç–µ –π–æ–≥–æ –º–µ–Ω—ñ –≤ —á–∞—Ç —è–∫ –æ–∫—Ä–µ–º–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è.** –Ø –≤—ñ–¥–ø–æ–≤—ñ–º –≥–æ—Ç–æ–≤–æ—é —à–ø–∞—Ä–≥–∞–ª–∫–æ—é.")
            elif result.startswith("[[LLM_REQUEST_FAILED]]"):
                # –õ–æ–≥—ñ–∫–∞ –¥–ª—è –ø–æ–º–∏–ª–∫–∏ API
                st.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Å–ø—Ä–æ–±—ñ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ—ó –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó.")
                st.info(result.replace("[[LLM_REQUEST_FAILED]]", ""))
            else:
                # 3. –í–ò–í–Ü–î –ì–û–¢–û–í–û–á –®–ü–ê–†–ì–ê–õ–ö–ò
                st.markdown("### ü•á –í–∞—à–∞ –≥–æ—Ç–æ–≤–∞ –®–ø–∞—Ä–≥–∞–ª–∫–∞:")
                st.markdown(result)


if __name__ == '__main__':
    main()
